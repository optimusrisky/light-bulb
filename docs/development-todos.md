# 開発フェーズ別TODOリスト

このドキュメントは、`manifest-guide.md`と`design.md`に基づいて、Chrome拡張機能「Light/Dark Mode Toggle」の開発をフェーズごとに整理したTODOリストです。

## フェーズ1: プロジェクト初期化・環境構築

### 1.1 プロジェクト構造の作成
- [x] プロジェクトルートディレクトリの作成
- [x] `package.json`の作成と初期化
- [x] ディレクトリ構造の作成
  - [x] `public/`ディレクトリ
  - [x] `public/icons/`ディレクトリ
  - [x] `src/`ディレクトリ
  - [x] `src/popup/`ディレクトリ
  - [x] `src/background/`ディレクトリ
  - [x] `src/content/`ディレクトリ
  - [x] `src/shared/`ディレクトリ
  - [x] `dist/`ディレクトリ（.gitignoreに追加）

### 1.2 依存パッケージのインストール
- [x] React関連パッケージのインストール
  - [x] `react` (^18.2.0)
  - [x] `react-dom` (^18.2.0)
- [x] TypeScript関連パッケージのインストール
  - [x] `typescript` (^5.3.0)
  - [x] `@types/react` (^18.2.0)
  - [x] `@types/react-dom` (^18.2.0)
  - [x] `@types/chrome` (^0.0.268)
- [x] ビルドツールのインストール
  - [x] `vite` (^5.0.0)
  - [x] `@vitejs/plugin-react` (^4.2.0)
  - [x] `vite-plugin-web-extension` (^4.1.0)
- [x] コード品質ツールのインストール
  - [x] `@biomejs/biome` (^1.9.0)

### 1.3 設定ファイルの作成
- [x] `tsconfig.json`の作成と設定
  - [x] TypeScriptコンパイラオプションの設定
  - [x] モジュール解決の設定
  - [x] 型定義の設定
- [x] `vite.config.ts`の作成と設定
  - [x] マルチエントリーポイントの設定（popup, background, content）
  - [x] Reactプラグインの設定
  - [x] Chrome拡張機能用ビルド設定
  - [x] 出力先の設定（dist/）
- [x] `biome.json`の作成と設定
  - [x] リンター設定
  - [x] フォーマッター設定
  - [x] インポート整理の設定
- [x] `.gitignore`の作成
  - [x] `node_modules/`の追加
  - [x] `dist/`の追加
  - [x] その他一般的な除外パターン

### 1.4 package.jsonスクリプトの設定
- [x] `npm run dev`スクリプトの追加（開発モード）
- [x] `npm run build`スクリプトの追加（本番ビルド）
- [x] `npm run lint`スクリプトの追加（Biome lint）
- [x] `npm run format`スクリプトの追加（Biome format）

---

## フェーズ2: マニフェストファイルとアイコンの準備

### 2.1 manifest.jsonの作成
- [x] `public/manifest.json`の作成
- [x] 基本情報の設定
  - [x] `manifest_version: 3`の設定
  - [x] `name: "Light/Dark Mode Toggle"`の設定
  - [x] `version: "1.0.0"`の設定
  - [x] `description`の設定
- [x] 権限設定
  - [x] `permissions: ["storage", "activeTab"]`の設定
  - [x] `host_permissions: ["<all_urls>"]`の設定
- [x] セキュリティポリシーの設定
  - [x] `content_security_policy`の設定
- [x] バックグラウンドスクリプトの設定
  - [x] `background.service_worker: "background.js"`の設定
  - [x] `background.type: "module"`の設定
- [x] コンテンツスクリプトの設定
  - [x] `content_scripts`配列の作成
  - [x] `matches: ["<all_urls>"]`の設定
  - [x] `js: ["content.js"]`の設定
  - [x] `run_at: "document_start"`の設定
  - [x] `all_frames: false`の設定
  - [x] 注意: `css`フィールドは不要（ブラウザのネイティブ機能のみ使用）
- [x] アクション設定
  - [x] `action.default_popup: "popup.html"`の設定
  - [x] `action.default_icon`の設定（16, 48, 128）
- [x] アイコン設定
  - [x] `icons`の設定（16, 48, 128）
- [x] その他の設定
  - [x] `web_accessible_resources: []`の設定

### 2.2 アイコンの準備
- [x] アイコンデザインの作成または取得
- [x] 各サイズのアイコンファイルの作成
  - [x] `public/icons/icon16.png`の作成
  - [x] `public/icons/icon48.png`の作成
  - [x] `public/icons/icon128.png`の作成
  - [x] `public/icons/icon-light.png`の作成（ライトモード用）
  - [x] `public/icons/icon-dark.png`の作成（ダークモード用）

---

## フェーズ3: 型定義と共通ユーティリティの実装

### 3.1 型定義の作成
- [ ] `src/shared/types.ts`の作成
  - [ ] `ThemeMode`型の定義（"light" | "dark"）
  - [ ] `StorageData`インターフェースの定義
    - [ ] `mode: ThemeMode`
    - [ ] `enabled: boolean`
  - [ ] `MessagePayload`インターフェースの定義
    - [ ] `type: "TOGGLE_MODE" | "GET_MODE" | "APPLY_MODE"`
    - [ ] `mode?: ThemeMode`
- [ ] `src/background/types.ts`の作成（必要に応じて）
- [ ] `src/vite-env.d.ts`の作成（Viteの型定義）

### 3.2 ストレージユーティリティの実装
- [ ] `src/shared/storage.ts`の作成
- [ ] ストレージ読み込み関数の実装
  - [ ] `getMode()`: 現在のモードを取得
  - [ ] `getStorageData()`: ストレージデータ全体を取得
- [ ] ストレージ書き込み関数の実装
  - [ ] `setMode(mode: ThemeMode)`: モードを設定
  - [ ] `toggleMode()`: モードを切り替え
  - [ ] `setStorageData(data: StorageData)`: ストレージデータを設定
- [ ] デフォルト値の設定
  - [ ] 初回起動時のデフォルトモード（"light"）の設定
- [ ] エラーハンドリングの実装
  - [ ] `chrome.runtime.lastError`のチェック
  - [ ] エラーログの出力

### 3.3 メッセージングユーティリティの実装
- [ ] `src/shared/messages.ts`の作成
- [ ] メッセージ送信関数の実装
  - [ ] `sendMessage<T>(message: MessagePayload): Promise<T>`
  - [ ] エラーハンドリングの実装
  - [ ] `chrome.runtime.lastError`のチェック
- [ ] メッセージ受信リスナーの実装
  - [ ] `onMessage(callback)`関数の実装
  - [ ] 非同期処理対応（`true`を返して`sendResponse`を保持）
- [ ] 型安全性の確保
  - [ ] メッセージタイプの型チェック

---

## フェーズ4: バックグラウンドスクリプトの実装

### 4.1 バックグラウンドスクリプトの基本実装
- [ ] `src/background/background.ts`の作成
- [ ] Service Workerの初期化
  - [ ] 拡張機能インストール時の処理
  - [ ] ストレージからの設定読み込み
  - [ ] デフォルト値の設定（初回起動時）
- [ ] モード管理機能の実装
  - [ ] 現在のモード状態の管理
  - [ ] モード切り替え処理
  - [ ] ストレージへの保存処理

### 4.2 メッセージハンドラーの実装
- [ ] `chrome.runtime.onMessage`リスナーの実装
- [ ] メッセージタイプ別のハンドラー実装
  - [ ] `TOGGLE_MODE`: モード切り替え処理
    - [ ] 現在のモードを取得
    - [ ] モードを反転
    - [ ] ストレージに保存
    - [ ] すべてのタブにメッセージ送信
    - [ ] アイコンの更新
    - [ ] レスポンスを返す
  - [ ] `GET_MODE`: 現在のモード取得
    - [ ] ストレージからモードを取得
    - [ ] レスポンスを返す
  - [ ] `APPLY_MODE`: モード適用
    - [ ] 指定されたモードをストレージに保存
    - [ ] すべてのタブにメッセージ送信
    - [ ] アイコンの更新
- [ ] エラーハンドリングの実装

### 4.3 タブ管理機能の実装
- [ ] 新規タブ開封時の処理
  - [ ] `chrome.tabs.onUpdated`リスナーの実装
  - [ ] タブが読み込まれた際に現在のモードを適用
- [ ] すべてのアクティブタブへのメッセージ送信
  - [ ] `chrome.tabs.query`でアクティブタブを取得
  - [ ] 各タブにメッセージを送信
- [ ] エラーハンドリングの実装

### 4.4 アイコン更新機能の実装
- [ ] アイコン更新関数の実装
  - [ ] `updateIcon(mode: ThemeMode)`関数の作成
  - [ ] `chrome.action.setIcon()`を使用
  - [ ] モードに応じたアイコンパスの設定
- [ ] モード切り替え時のアイコン更新
- [ ] 初期化時のアイコン設定

### 4.5 Service Workerのライフサイクル対応
- [ ] アイドル時の停止に対応
  - [ ] 状態をストレージに保存
  - [ ] 起動時に状態を復元
- [ ] イベントリスナーの同期的登録
- [ ] 長時間実行が必要な処理の対応（必要に応じて`chrome.alarms`を使用）

---

## フェーズ5: コンテンツスクリプトの実装

### 5.1 コンテンツスクリプトの基本実装
- [ ] `src/content/content.ts`の作成
- [ ] スクリプトの初期化処理
  - [ ] ページ読み込み時の処理
  - [ ] バックグラウンドから現在のモードを取得
  - [ ] モードに応じたスタイル適用

### 5.2 メッセージハンドラーの実装
- [ ] `chrome.runtime.onMessage`リスナーの実装
- [ ] メッセージタイプ別のハンドラー実装
  - [ ] `APPLY_MODE`: モード適用処理
    - [ ] スタイルの適用/削除
    - [ ] レスポンスを返す
  - [ ] `GET_MODE`: 現在のモード取得（必要に応じて）

### 5.3 スタイル適用機能の実装（ブラウザのネイティブな`color-scheme`のみを使用）
- [ ] `color-scheme`プロパティの設定（CSSファイルは不要）
  - [ ] `document.documentElement.style.colorScheme = 'dark'`の実装
  - [ ] `document.documentElement.style.colorScheme = 'light'`の実装
  - [ ] または`<meta name="color-scheme">`タグの動的追加/削除（`document_start`で実行する場合）
- [ ] スタイル適用関数の実装
  - [ ] `applyDarkMode()`: ダークモードを適用
    - [ ] `color-scheme`を`'dark'`に設定するのみ
    - [ ] 拡張機能独自のCSSは適用しない
  - [ ] `applyLightMode()`: ライトモードを適用
    - [ ] `color-scheme`を`'light'`に設定するのみ
    - [ ] 拡張機能独自のCSSは適用しない
  - [ ] `toggleMode(mode: ThemeMode)`: モードに応じて`color-scheme`を切り替え
- [ ] パフォーマンス最適化
  - [ ] ブラウザのネイティブ機能を活用（スクロールバー、フォームコントロールなど）
  - [ ] サイトが`prefers-color-scheme`に対応している場合、自動的に適切なスタイルが適用される

### 5.4 CSSファイルは不要
- [ ] **注意**: 拡張機能独自のCSSファイルは作成しない
- [ ] ブラウザのネイティブな`color-scheme`プロパティのみを使用
- [ ] サイトが`prefers-color-scheme`メディアクエリに対応している場合、自動的に適切なスタイルが適用される
- [ ] サイトが`prefers-color-scheme`に対応していない場合でも、ブラウザのUI要素（スクロールバー、フォームコントロールなど）はダーク/ライトモードになる

### 5.5 ページ読み込み時の処理
- [ ] `document_start`での実行に対応
- [ ] フラッシュ（一瞬ライトモードが表示される）の防止
- [ ] DOM構築前でも動作する実装

---

## フェーズ6: ポップアップUI（React）の実装

### 6.1 Reactアプリケーションのセットアップ
- [ ] `src/popup/index.tsx`の作成
  - [ ] ReactDOMのインポート
  - [ ] ルート要素へのマウント
  - [ ] Popupコンポーネントのレンダリング
- [ ] `src/popup/Popup.tsx`の作成
  - [ ] Reactコンポーネントの基本構造
  - [ ] 状態管理の実装（`useState`）
  - [ ] エフェクトの実装（`useEffect`）

### 6.2 UIコンポーネントの実装
- [ ] 現在のモード表示
  - [ ] モード状態の表示（アイコン、テキスト）
  - [ ] 視覚的なフィードバック
- [ ] 切り替えボタンの実装
  - [ ] トグルスイッチ形式のボタン
  - [ ] クリックイベントハンドラー
  - [ ] モード切り替え処理の呼び出し
- [ ] ローディング状態の表示
  - [ ] 非同期処理中の表示
- [ ] エラー状態の表示
  - [ ] エラーメッセージの表示

### 6.3 状態管理とデータ取得
- [ ] 初期状態の取得
  - [ ] `useEffect`でバックグラウンドからモードを取得
  - [ ] ストレージから直接取得（オプション）
- [ ] モード切り替え処理
  - [ ] `toggleMode()`の呼び出し
  - [ ] 状態の更新
  - [ ] エラーハンドリング
- [ ] リアルタイム更新
  - [ ] メッセージリスナーでモード変更を検知
  - [ ] 状態の同期

### 6.4 スタイリング
- [ ] `src/popup/Popup.css`の作成
- [ ] ポップアップのレイアウト
  - [ ] コンテナのスタイル
  - [ ] レスポンシブデザイン
- [ ] コンポーネントのスタイル
  - [ ] ボタンのスタイル
  - [ ] トグルスイッチのスタイル
  - [ ] アニメーション効果（トランジション）
- [ ] ダークモード対応（ポップアップ自体のテーマ）

### 6.5 HTMLファイルの作成
- [ ] `public/popup.html`の作成
  - [ ] 基本的なHTML構造
  - [ ] Reactアプリのマウントポイント（`<div id="root">`）
  - [ ] スクリプトの読み込み（ビルド後の`popup.js`）
  - [ ] スタイルシートの読み込み（必要に応じて）

---

## フェーズ7: ビルド設定と最適化

### 7.1 Viteビルド設定の確認・調整
- [ ] マルチエントリーポイントの確認
  - [ ] `popup`エントリーの設定
  - [ ] `background`エントリーの設定
  - [ ] `content`エントリーの設定
- [ ] 出力設定の確認
  - [ ] 出力先ディレクトリ（`dist/`）
  - [ ] ファイル名の設定
- [ ] リソースのコピー設定
  - [ ] `manifest.json`のコピー
  - [ ] アイコンファイルのコピー
  - [ ] 注意: CSSファイルは不要（ブラウザのネイティブ機能のみ使用）

### 7.2 ビルド最適化
- [ ] Reactバンドルサイズの最適化
  - [ ] コード分割の設定（必要に応じて）
  - [ ] 不要な依存関係の削除
- [ ] TypeScriptコンパイルの最適化
  - [ ] 型チェックの設定
  - [ ] ソースマップの設定
- [ ] 本番ビルドの最適化
  - [ ] ミニファイの設定
  - [ ] ツリーシェイキングの確認

### 7.3 開発環境の確認
- [ ] 開発サーバーの動作確認
- [ ] ホットリロードの動作確認
- [ ] ビルドエラーの確認と修正

---

## フェーズ8: テストとデバッグ

### 8.1 機能テスト
- [ ] 拡張機能のインストールテスト
  - [ ] Chrome拡張機能として読み込み
  - [ ] エラーがないことを確認
- [ ] ポップアップの動作テスト
  - [ ] アイコンクリックでポップアップが表示される
  - [ ] 現在のモードが正しく表示される
- [ ] モード切り替えのテスト
  - [ ] ライト→ダークモードの切り替え
  - [ ] ダーク→ライトモードの切り替え
  - [ ] ポップアップUIの更新
  - [ ] アイコンの更新
- [ ] `color-scheme`プロパティの設定テスト
  - [ ] ダークモード時に`document.documentElement.style.colorScheme = 'dark'`が設定される
  - [ ] ライトモード時に`document.documentElement.style.colorScheme = 'light'`が設定される
  - [ ] ブラウザのUI要素（スクロールバー、フォームコントロールなど）がダーク/ライトモードになる
  - [ ] サイトが`prefers-color-scheme`に対応している場合、自動的に適切なスタイルが適用される
  - [ ] フラッシュ（一瞬ライトモードが表示される）がない（`document_start`で実行）

### 8.2 ストレージ機能のテスト
- [ ] 設定の保存テスト
  - [ ] モード設定がストレージに保存される
  - [ ] ストレージから正しく読み込まれる
- [ ] 永続化のテスト
  - [ ] ページリロード後も設定が維持される
  - [ ] ブラウザ再起動後も設定が維持される

### 8.3 マルチタブ対応のテスト
- [ ] 複数タブでの動作テスト
  - [ ] 複数のタブで同時に動作する
  - [ ] モード切り替えがすべてのタブに反映される
  - [ ] 新規タブ開封時に設定が適用される

### 8.4 様々なWebサイトでのテスト
- [ ] 主要なWebサイトでの動作確認
  - [ ] Google（`prefers-color-scheme`に対応しているサイト）
  - [ ] YouTube（`prefers-color-scheme`に対応しているサイト）
  - [ ] GitHub（`prefers-color-scheme`に対応しているサイト）
  - [ ] Twitter/X（`prefers-color-scheme`に対応しているサイト）
  - [ ] `prefers-color-scheme`に対応していないサイト（ブラウザのUI要素のみ変更されることを確認）
- [ ] エラーが発生しないことを確認
- [ ] パフォーマンスへの影響を確認（`color-scheme`プロパティの設定のみなので、影響は最小限）
- [ ] サイトの既存スタイルが壊れないことを確認

### 8.5 コード品質チェック
- [ ] TypeScriptの型チェック
  - [ ] `npm run build`でエラーがない
  - [ ] 型エラーの修正
- [ ] Biomeのlintチェック
  - [ ] `npm run lint`でエラーがない
  - [ ] lintエラーの修正
- [ ] コードフォーマット
  - [ ] `npm run format`でフォーマット
  - [ ] コードスタイルの統一

### 8.6 エラーハンドリングのテスト
- [ ] ストレージエラーのテスト
- [ ] メッセージングエラーのテスト
- [ ] エラーメッセージの表示確認

### 8.7 Service Workerのテスト
- [ ] Service Workerの起動・停止の確認
- [ ] アイドル時の停止・復帰の確認
- [ ] 状態の復元が正しく動作する

### 8.8 セキュリティテスト
- [ ] CSPに準拠していることを確認
- [ ] 外部リソースへのアクセスが制限されていることを確認
- [ ] セキュリティ警告がないことを確認

---

## フェーズ9: ドキュメントとパッケージング

### 9.1 READMEの作成・更新
- [ ] `README.md`の作成
  - [ ] プロジェクトの概要
  - [ ] 機能説明
  - [ ] インストール方法
  - [ ] 使用方法
  - [ ] 開発方法
  - [ ] ビルド方法
  - [ ] ライセンス情報

### 9.2 ドキュメントの整理
- [ ] 設計書の確認
- [ ] コメントの追加（必要に応じて）
- [ ] コード内のドキュメントコメントの追加

### 9.3 パッケージング準備
- [ ] 本番ビルドの実行
  - [ ] `npm run build`の実行
  - [ ] ビルドエラーの確認と修正
- [ ] ビルド成果物の確認
  - [ ] `dist/`ディレクトリの内容確認
  - [ ] 必要なファイルがすべて含まれていることを確認
- [ ] アイコンファイルの確認
  - [ ] すべてのサイズのアイコンが含まれている
  - [ ] パスが正しいことを確認

### 9.4 Chrome Web Store公開準備（オプション）
- [ ] ストア用の説明文の作成
- [ ] スクリーンショットの準備
- [ ] プライバシーポリシーの作成（必要に応じて）
- [ ] ストア用のアイコンと画像の準備

---

## フェーズ10: 最終確認とリリース

### 10.1 最終テスト
- [ ] 全機能の動作確認
- [ ] パフォーマンステスト
- [ ] セキュリティチェック
- [ ] コードレビュー（自己レビュー）

### 10.2 バージョン管理
- [ ] バージョン番号の確認（`manifest.json`と`package.json`）
- [ ] 変更履歴の記録（CHANGELOG.mdの作成、オプション）
- [ ] Gitコミットとタグ付け（必要に応じて）

### 10.3 リリース
- [ ] 本番ビルドの最終確認
- [ ] 拡張機能のパッケージング（.zipファイルの作成、オプション）
- [ ] Chrome Web Storeへの公開（オプション）
- [ ] ローカルでの配布準備（オプション）

---

## 補足: 開発時の注意点

### 開発フロー
1. `npm run dev`で開発モードを起動
2. Chromeで`chrome://extensions/`を開く
3. 「デベロッパーモード」を有効化
4. 「パッケージ化されていない拡張機能を読み込む」をクリック
5. `dist/`フォルダを選択
6. コードを変更したら、ビルドを再実行して拡張機能をリロード

### デバッグ方法
- **ポップアップ**: ポップアップを右クリック→「検証」でDevToolsを開く
- **バックグラウンドスクリプト**: 拡張機能の管理画面で「Service Worker」をクリック
- **コンテンツスクリプト**: 通常のWebページのDevToolsで確認
- **ストレージ**: DevToolsの「Application」タブ→「Storage」→「Chrome Extension」で確認

### よくある問題と対処法
- **Service Workerが停止する**: 正常な動作。状態はストレージに保存されている
- **スタイルが適用されない**: `run_at: "document_start"`を確認、CSSファイルのパスを確認
- **メッセージが届かない**: エラーハンドリングを確認、`chrome.runtime.lastError`をチェック
- **アイコンが更新されない**: アイコンパスを確認、相対パスが正しいか確認

---

**作成日**: 2026年1月28日  
**更新日**: 2026年1月28日  
**対象**: Chrome拡張機能「Light/Dark Mode Toggle」開発プロジェクト
